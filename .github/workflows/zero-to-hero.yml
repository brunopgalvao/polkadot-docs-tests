name: Zero to Hero
description: "Zero to Hero"

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to clone"
        required: false
        default: "main"
        type: string
      chain-spec-builder-version:
        description: 'Polkadot chain-spec-builder version'
        required: false
        type: string
      omni-node-version:
        description: 'Polkadot omni-node version'
        required: false
        type: string
      run-duration:
        description: 'How long to run the node (in seconds, 0 for indefinite)'
        default: '120'
        required: false
        type: string

jobs:
  # Parallel setup jobs for better performance
  setup-dependencies:
      name: Setup Dependencies
      runs-on: ubuntu-latest
      outputs:
        chain-spec-builder-version: ${{ steps.resolve.outputs.chain-spec-builder-version }}
        omni-node-version: ${{ steps.resolve.outputs.omni-node-version }}
        rust-version: ${{ steps.resolve.outputs.rust-version }}
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Resolve dependency versions
          id: resolve
          run: |
            # Install yq for YAML parsing
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
            
            DEPS_FILE=".github/versions.yml"
            TUTORIAL="zero_to_hero"
            
            # Function to get version (tutorial-specific first, then global)
            get_version() {
              local dep="$1"
              local version
              
              # Try tutorial-specific version first
              version=$(yq eval ".${TUTORIAL}.${dep}" "$DEPS_FILE" 2>/dev/null)
              if [ "$version" = "null" ] || [ -z "$version" ]; then
                # Fallback to global version
                version=$(yq eval ".versions.${dep}" "$DEPS_FILE" 2>/dev/null)
              fi
              
              echo "$version"
            }
            
            # Resolve versions (input takes precedence, then config file)
            CHAIN_SPEC_VERSION="${{ inputs.chain-spec-builder-version }}"
            if [ -z "$CHAIN_SPEC_VERSION" ]; then
              CHAIN_SPEC_VERSION=$(get_version "chain_spec_builder")
            fi
            
            OMNI_NODE_VERSION="${{ inputs.omni-node-version }}"
            if [ -z "$OMNI_NODE_VERSION" ]; then
              OMNI_NODE_VERSION=$(get_version "polkadot_omni_node")
            fi
            
            RUST_VERSION=$(get_version "rust")
            
            echo "chain-spec-builder-version=$CHAIN_SPEC_VERSION" >> $GITHUB_OUTPUT
            echo "omni-node-version=$OMNI_NODE_VERSION" >> $GITHUB_OUTPUT
            echo "rust-version=$RUST_VERSION" >> $GITHUB_OUTPUT
            
            echo "ðŸ“‹ Resolved versions:"
            echo "  - chain-spec-builder: $CHAIN_SPEC_VERSION"
            echo "  - omni-node: $OMNI_NODE_VERSION" 
            echo "  - rust: $RUST_VERSION"

  setup-tools:
    name: Setup Tools
    runs-on: ubuntu-latest
    outputs:
      chain-spec-builder-version: ${{ steps.chain-spec.outputs.version }}
      omni-node-version: ${{ steps.omni-node.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup chain-spec-builder
        id: chain-spec
        uses: ./.github/actions/setup-chain-spec-builder
        with:
          chain-spec-builder-version: ${{ inputs.chain-spec-builder-version }}
          rust-version: ${{ env.RUST_VERSION }}

      - name: Setup omni-node
        id: omni-node
        uses: ./.github/actions/setup-omni-node
        with:
          omni-node-version: ${{ inputs.omni-node-version }}
          rust-version: ${{ env.RUST_VERSION }}

      - name: Cache tools for main job
        uses: actions/cache/save@v4
        with:
          path: ~/.cargo/bin
          key: tools-${{ runner.os }}-${{ runner.arch }}-${{ inputs.chain-spec-builder-version }}-${{ inputs.omni-node-version }}

  build-parachain:
    name: Build Parachain
    runs-on: ubuntu-latest
    outputs:
      parachain-path: ${{ steps.setup-template.outputs.parachain-path }}
      runtime-path: ${{ steps.setup-template.outputs.runtime-path }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Zero to Hero parachain
        id: setup-parachain
        uses: ./.github/actions/setup-zero-to-hero-parachain
        with:
          branch: ${{ inputs.branch }}
          rust-version: ${{ env.RUST_VERSION }}

      - name: Upload parachain artifacts
        uses: actions/upload-artifact@v4
        with:
          name: parachain-artifacts-${{ github.run_id }}
          path: |
            ${{ steps.setup-parachain.outputs.runtime-path }}
          retention-days: 1

  run-parachain:
    name: Run Parachain Node
    runs-on: ubuntu-latest
    needs: [setup-tools, build-parachain]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore tools cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cargo/bin
          key: tools-${{ runner.os }}-${{ runner.arch }}-${{ inputs.chain-spec-builder-version }}-${{ inputs.omni-node-version }}
          fail-on-cache-miss: true

      - name: Download parachain artifacts
        uses: actions/download-artifact@v4
        with:
          name: parachain-artifacts-${{ github.run_id }}
          path: ./artifacts

      - name: Setup paths and permissions
        run: |
          # Add tools to PATH
          echo "${HOME}/.cargo/bin" >> $GITHUB_PATH
          
          # Make binaries executable
          find ./artifacts -name "*parachain*" -type f -exec chmod +x {} \;
          
          # Verify tools are available
          chain-spec-builder --version
          polkadot-omni-node --version

          # Find the runtime WASM file
          RUNTIME_WASM=$(find ./artifacts -name "*.compressed.wasm" -type f | head -1)
          if [ -z "$RUNTIME_WASM" ]; then
            echo "âŒ Runtime WASM file not found"
            echo "Available files:"
            find ./artifacts -type f
            exit 1
          fi
          
          mkdir -p ./target/release/wbuild/parachain-template-runtime/
          cp $RUNTIME_WASM ./target/release/wbuild/parachain-template-runtime/

      - name: Generate chain specification
        run: |
          echo "ðŸ”§ Generating chain specification..."
          echo "ðŸ“‹ Using repository: https://github.com/brunopgalvao/polkadot-sdk-docs-tests"
          echo "ðŸ“‹ Using branch: ${{ inputs.branch }}"
          
          # Generate chain spec
          chain-spec-builder create \
            -t development \
            --relay-chain paseo \
            --para-id 1000 \
            --runtime ./target/release/wbuild/parachain-template-runtime/parachain_template_runtime.compact.compressed.wasm \
            named-preset development
          
          # Verify chain spec was created
          if [ ! -f "chain_spec.json" ]; then
            echo "âŒ Chain spec generation failed"
            exit 1
          fi
          
          echo "âœ… Chain specification generated successfully"
          echo "ðŸ“„ Chain spec size: $(du -h chain_spec.json | cut -f1)"

      - name: Validate chain specification
        run: |
          echo "ðŸ” Validating chain specification..."
          
          # Check if it's valid JSON
          if ! jq empty chain_spec.json 2>/dev/null; then
            echo "âŒ Invalid JSON in chain specification"
            exit 1
          fi
          
          # Extract key information
          CHAIN_NAME=$(jq -r '.name // "unknown"' chain_spec.json)
          PARA_ID=$(jq -r '.para_id // "unknown"' chain_spec.json)
          RELAY_CHAIN=$(jq -r '.relay_chain // "unknown"' chain_spec.json)
          
          echo "âœ… Chain specification is valid"
          echo "ðŸ“‹ Chain Name: $CHAIN_NAME"
          echo "ðŸ†” Para ID: $PARA_ID"
          echo "ðŸ”— Relay Chain: $RELAY_CHAIN"
          echo "ðŸ“¦ Parachain Source: https://github.com/brunopgalvao/polkadot-sdk-docs-tests@${{ inputs.branch }}"

      - name: Start Polkadot omni-node
        timeout-minutes: 5
        run: |
          echo "ðŸš€ Starting Polkadot omni-node..."
          echo "ðŸ“¦ Built from: https://github.com/brunopgalvao/polkadot-sdk-docs-tests@${{ inputs.branch }}"
          
          # Determine run duration
          RUN_DURATION=${{ inputs.run-duration }}
          if [ "$RUN_DURATION" = "0" ]; then
            echo "âš ï¸ Running indefinitely (workflow will timeout after 6 hours)"
            TIMEOUT_CMD=""
          else
            echo "â±ï¸ Running for ${RUN_DURATION} seconds"
            TIMEOUT_CMD="timeout ${RUN_DURATION}s"
          fi
          
          # Start node in background with logging
          $TIMEOUT_CMD \
          polkadot-omni-node \
            --chain ./chain_spec.json \
            --dev \
            > node.log 2>&1 &
          
          NODE_PID=$!
          echo "NODE_PID=$NODE_PID" >> $GITHUB_ENV
          
          echo "âœ… Node started with PID: $NODE_PID"
          
          # Wait a moment for startup
          sleep 10
          
          # Check if node is still running
          if ! kill -0 $NODE_PID 2>/dev/null; then
            echo "âŒ Node failed to start"
            echo "ðŸ“‹ Last 50 lines of log:"
            tail -50 node.log
            exit 1
          fi
          
          echo "âœ… Node is running successfully"

      - name: Health check and monitoring
        timeout-minutes: 2
        run: |
          echo "ðŸ¥ Performing health checks..."
          
          # Monitor node for a short period
          for i in {1..12}; do
            if ! kill -0 $NODE_PID 2>/dev/null; then
              echo "âŒ Node stopped unexpectedly"
              echo "ðŸ“‹ Final log output:"
              tail -100 node.log
              exit 1
            fi
            
            echo "âœ… Health check $i/12 - Node is running"
            sleep 5
          done
          
          echo "âœ… All health checks passed"

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          
          # Stop the node gracefully
          if [ -n "${NODE_PID:-}" ] && kill -0 $NODE_PID 2>/dev/null; then
            echo "ðŸ›‘ Stopping node (PID: $NODE_PID)..."
            kill -TERM $NODE_PID
            
            # Wait for graceful shutdown
            for i in {1..10}; do
              if ! kill -0 $NODE_PID 2>/dev/null; then
                echo "âœ… Node stopped gracefully"
                break
              fi
              sleep 1
            done
            
            # Force kill if still running
            if kill -0 $NODE_PID 2>/dev/null; then
              echo "âš¡ Force stopping node..."
              kill -KILL $NODE_PID
            fi
          fi
          
          echo "âœ… Cleanup completed"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: node-logs-${{ github.run_id }}
          path: |
            node.log
            chain_spec.json
          retention-days: 7